var LookupBrowse=1,LookupShowColumns=2,LookupMultiSelect=4,EmptyGuid="00000000-0000-0000-0000-000000000000";function LookupItem(){this.id="";this.name="";this.html="";this.type="";this.values=null;this.keyValues=null;this.category=null;this.ambiguousRecordsXml=null;this.selected=false;this.displayclass=""}function LookupItems(){this.items=[]}function LookupItemData(name,value){this.name=name;this.value=value}function LookupArgsClass(){this.items=null;this.customViews=null;this.availableViews=null}function LookupControlItem(sId,iType,sName,sOnclick,sDisplayClass,sData,sTypeName,iCategory,sAmbiguousRecordsXml,bSelected){this.id=sId;this.type=iType;this.name=sName;this.onclick=sOnclick;this.displayClass=sDisplayClass;this.data=sData;this.typename=sTypeName;this.category=iCategory;this.ambiguousRecordsXml=sAmbiguousRecordsXml;this.selected=bSelected}function CustomView(id,iRecordTypeId,sName,sFetchXml,sLayoutXml){this.id=id;this.recordType=iRecordTypeId;this.name=sName;this.fetchXml=sFetchXml;this.layoutXml=sLayoutXml;this.Type=0}function LookupObjectsForOutlook(lookupField){if(!IsNull(lookupField)){lookupField=Mscrm.FormControlInputBehavior.GetBehavior(lookupField);lookupField.Lookup()}}function LookupObjectsWithCallback(callbackReference,lookupField,lookupStyle,lookupTypes,lookupBrowse,bindingColumns,additionalParams,showNew,showProp,bPopulateLookup,defaultType,searchString,dataProviderOverride,defaultViewId,customViews,filterRelationshipId,rId,rType,rDependAttr,allowFilterOff,disableQuickFind,disableViewPicker,viewsIds){return LookupObjects(lookupField,lookupStyle,lookupTypes,lookupBrowse,bindingColumns,additionalParams,showNew,showProp,bPopulateLookup,defaultType,searchString,dataProviderOverride,defaultViewId,customViews,filterRelationshipId,rId,rType,rDependAttr,allowFilterOff,disableQuickFind,disableViewPicker,viewsIds,"",callbackReference)}function LookupObjects(lookupField,lookupStyle,lookupTypes,lookupBrowse,bindingColumns,additionalParams,showNew,showProp,bPopulateLookup,defaultType,searchString,dataProviderOverride,defaultViewId,customViews,filterRelationshipId,rId,rType,rDependAttr,allowFilterOff,disableQuickFind,disableViewPicker,viewsIds){LookupObjects(lookupField,lookupStyle,lookupTypes,lookupBrowse,bindingColumns,additionalParams,showNew,showProp,bPopulateLookup,defaultType,searchString,dataProviderOverride,defaultViewId,customViews,filterRelationshipId,rId,rType,rDependAttr,allowFilterOff,disableQuickFind,disableViewPicker,viewsIds,"",null)}function LookupObjects(lookupField,lookupStyle,lookupTypes,lookupBrowse,bindingColumns,additionalParams,showNew,showProp,bPopulateLookup,defaultType,searchString,dataProviderOverride,defaultViewId,customViews,filterRelationshipId,rId,rType,rDependAttr,allowFilterOff,disableQuickFind,disableViewPicker,viewsIds,crmAttributeId,callbackReference){var args=new LookupArgsClass;args.customViews=customViews;args.availableViews=viewsIds;if(lookupField!=null){args.items=[];for(var a=lookupField.getElementsByTagName("SPAN"),bSetSearchString=searchString===""||IsNull(searchString),tempDefaultType=defaultType,i=a.length-1;i>=0;i--)if(a[i].getAttribute("wrapper")!="true"){var item=a[i];if(item.getAttribute("otype")!=="0"||item.getAttribute("otypename")!==""||!IsNull(item.getAttribute("activitypartyid"))){args.items.push(item);tempDefaultType=item.getAttribute("otype")}else{if(bSetSearchString==true)searchString=XUI.Html.GetText(item);if(searchString===XUI.Html.GetText(item)&&!IsNull(item.getAttribute("ambiguousRecordsXml")))for(var oXmlDoc=XUI.Xml.LoadXml(item.getAttribute("ambiguousRecordsXml")),oRecords=XUI.Xml.SelectNodes(oXmlDoc,"/records/record",null),oLookupCtrl=getLookupControlFromItemSpan(item),iaLookupTypes=oLookupCtrl.get_lookupTypes().split(","),j=0;j<oRecords.length;j++){var iObjectType=parseInt(oRecords[j].getAttribute("otype"),10);if(j==0)tempDefaultType=iObjectType;else if(iObjectType!=tempDefaultType)for(var k=0;k<iaLookupTypes.length;k++)if(iaLookupTypes[k]==tempDefaultType)break;else if(iaLookupTypes[k]==iObjectType){tempDefaultType=iObjectType;break}}}}if(tempDefaultType!=defaultType)for(var lookupTypesArr=lookupTypes.split(","),i=0;i<lookupTypesArr.length;i++)if(lookupTypesArr[i]==tempDefaultType){defaultType=tempDefaultType;defaultViewId=null;break}args.items.reverse()}var bIsSubjectLookup=lookupStyle.toUpperCase()==="SUBJECT",oUrl=bIsSubjectLookup?Mscrm.CrmUri.create("/_controls/lookup/lookupsubject.aspx"):Mscrm.CrmUri.create("/_controls/lookup/lookupinfo.aspx");oUrl.get_query()["browse"]=lookupBrowse;if(!bIsSubjectLookup){if(!IsNull(disableViewPicker))oUrl.get_query()["DisableViewPicker"]=disableViewPicker;if(!IsNull(disableQuickFind))oUrl.get_query()["DisableQuickFind"]=disableQuickFind;if(!IsNull(allowFilterOff))oUrl.get_query()["AllowFilterOff"]=allowFilterOff}if(!bIsSubjectLookup)oUrl.get_query()["LookupStyle"]=lookupStyle;if(typeof dataProviderOverride!="undefined"&&!IsNull(dataProviderOverride)&&dataProviderOverride!="")oUrl.get_query()["DataProvider"]=dataProviderOverride;if(bindingColumns)oUrl.get_query()["bindingcolumns"]=bindingColumns;additionalParams&&additionalParams.length>0&&oUrl.appendToQuery(additionalParams);if(showNew)if(!additionalParams||additionalParams&&additionalParams.indexOf("ShowNewButton=")===-1)oUrl.get_query()["ShowNewButton"]=showNew;var lookTypeCode=parseInt(lookupTypes,10);if(lookTypeCode==Annotation||lookTypeCode==IncidentResolution)oUrl.get_query()["EnableNewButton"]=0;if(lookTypeCode==CustomerAddress){var currentForm=GetCurrentForm(lookupField);if(!IsNull(currentForm)&&currentForm.ObjectTypeCode==ContractDetail){rType=GetParam(additionalParams,"rType");rId=CrmEncodeDecode.CrmUrlDecode(GetParam(additionalParams,"rId"));oUrl.get_query()["parentType"]=rType;oUrl.get_query()["parentId"]=rId}}if(filterRelationshipId){oUrl.get_query()["relationshipid"]=filterRelationshipId;oUrl.get_query()["rId"]=rId;oUrl.get_query()["rType"]=rType;oUrl.get_query()["rDependAttr"]=rDependAttr}if(showProp)oUrl.get_query()["ShowPropButton"]=showProp;if(!IsNull(defaultType))oUrl.get_query()["DefaultType"]=defaultType;if(searchString)oUrl.get_query()["search"]=searchString;if(defaultViewId&&defaultViewId.length>0)oUrl.get_query()["DefaultViewId"]=defaultViewId;oUrl.get_query()["objecttypes"]=lookupTypes;if(crmAttributeId!=""&&!bIsSubjectLookup&&oUrl.toString().length>=2048){oUrl.get_query()["objecttypes"]=null;oUrl.get_query()["crmattributeid"]=crmAttributeId}var oFeatures=BuildFeatures(lookupStyle);if(oFeatures==null)return;bPopulateLookup="undefined"==typeof bPopulateLookup?true:bPopulateLookup;var parameters=[lookupField,bPopulateLookup,callbackReference],callbackFunctionObject=Mscrm.Utilities.createCallbackFunctionObject("buildAndReturnLookupItems",this,parameters),lookupItems=openStdDlgWithCallback(oUrl,args,oFeatures.width,oFeatures.height,callbackFunctionObject,true);Mscrm.Utilities.isModalDialogSupported()&&buildAndReturnLookupItems(lookupItems,lookupField,bPopulateLookup);return lookupItems}function buildAndReturnLookupItems(lookupItems,lookupField,bPopulateLookup,callbackReference){lookupItems!=null&&lookupField!=null&&bPopulateLookup&&BuildField(lookupField,lookupItems);Mscrm.Utilities.executeFunctionIfModeless(callbackReference,lookupItems)}function GetCurrentForm(element){var o=element;while(!IsNull(o)&&o.tagName!="FORM")o=o.parentNode;if(IsNull(o))return null;return o.className=="ms-crm-Form"?$find(o.id):null}function GetParam(params,name){if(!IsNull(params)&&params!=""){var i=params.indexOf(name);if(i>-1){var iEnd=params.indexOf("&",i),iNameEnd=params.indexOf("=",i);if(iEnd==-1)iEnd=params.length;return params.substring(iNameEnd+1,iEnd)}}return ""}function BuildFieldSpan(lookupField,lookupItems){for(var html="",len=lookupItems.items.length,spanElementFormat='<span class="ms-crm-Lookup-Item" oid="{0}" otype="{1}" selected="{2}">{3}</span>',i=0;i<len;++i){var item=lookupItems.items[i];html+=i>0?" ":"";html+=String.format(spanElementFormat,item.id,item.type,item.selected,item.html)}if(html.length==0)html="&nbsp;";return html}function BuildField(lookupField,lookupItems){lookupField.innerHTML=BuildFieldSpan(lookupField,lookupItems)}function BuildFeatures(lookupStyle){var oFeatures={};switch(lookupStyle){case "multi":oFeatures.height=600;oFeatures.width=600;break;case "single":oFeatures.height=600;oFeatures.width=600;break;case "subject":oFeatures.height=450;oFeatures.width=500;break;default:alert(LOCID_LOOKUPSTYLE_NOT_SET+lookupStyle);return null}return oFeatures}var _iClickTimer,_clickedElement;function handleGridClick(domEventObject){if(_iClickTimer==null){domEventObject.stopPropagation();o=domEventObject.target;while(o.tagName!="SPAN")o=o.parentNode;_clickedElement=o;var func=function(){openlui(domEventObject)};_iClickTimer=window.setTimeout(func,500)}}function handleLookupAnchorClick(domEventObject){o=domEventObject.target;while(o.tagName!="SPAN")o=XUI.Html.DomUtils.GetFirstChild(o);_clickedElement=o;openlui(domEventObject,o)}function clearTimer(){window.clearTimeout(_iClickTimer);_iClickTimer=null}function openDisabledLui(domEventObject){(domEventObject.keyCode==KEY_ENTER||domEventObject.keyCode==KEY_SPACE)&&openlui(domEventObject,domEventObject.target)}var _oEnhancedPreview=null;function showPreviewRowWindowTemp(oTr,top,left){return;if(IsNull(oTr)||IsNull(oTr.otype)||IsNull(oTr.oid))return;if(IsNull(_oEnhancedPreview))_oEnhancedPreview=new Mscrm.EnhancedPreviewControl;_oEnhancedPreview.show(top,left,oTr.otype,oTr.oid,oTr)}function handleGridRightClick(domEventObject){domEventObject.stopPropagation();domEventObject.preventDefault();o=domEventObject.target;if(o.getAttribute("wrapper")=="true")o=o.parentNode;while(o.tagName!="SPAN")o=o.parentNode}var _oAmbiguousPopup=null;function openlui(domEventObject,o){var bIsATEvent=false;if(IsNull(domEventObject)&&IsNull(o)){o=_clickedElement;clearTimer()}else if(IsNull(o)){o=domEventObject.target;bIsATEvent=o.className=="atLink";while(o.tagName!="SPAN"||o.getAttribute("wrapper")=="true")o=o.parentNode;clearTimer()}if(o.getAttribute("otype")==UnresolvedAddress)resolveAddress(o.getAttribute("otype"),o.getAttribute("oid"));else if(o.getAttribute("category")==LookupItemCategories.AMBIGUOUS){var oXmlDoc=XUI.Xml.LoadXml(o.getAttribute("ambiguousRecordsXml"));if(IsNull(_oAmbiguousPopup))_oAmbiguousPopup=createMenu();else _oAmbiguousPopup.clear();var notificationitem=Mscrm.MenuItem.createMenuItem(LOCID_LOOKUPAMBIGUOUSTITLE),listItem=document.createElement("li");listItem.style.height="22px";listItem.innerHTML=String.format('<div class="Notifications" style="text-align:center;height:18px;padding-top:2px">{0}</div>',LOCID_LOOKUPAMBIGUOUSTITLE);notificationitem.set_itemContents(listItem);notificationitem.set_isFocusable(false);_oAmbiguousPopup.addItem(notificationitem);for(var oLookupCtrl=getLookupControlFromItemSpan(o),oRecords=XUI.Xml.SelectNodes(oXmlDoc,"/records/record",null),i=0;i<oRecords.length;i++){var item=Mscrm.MenuItem.createMenuItem(oRecords[i].getAttribute("oname"));item.set_iconPath(oLookupCtrl.GetLookupTypeIcon(parseInt(oRecords[i].getAttribute("otype"),10)).get_source());item.set_tooltip(oRecords[i].getAttribute("oname"));item.set_stylePrefix(Mscrm.MenuStyles.lookupMruStylePrefix);item.set_reference(i);var sCallBack=Function.createDelegate(this,function(menuItem){var oItem=new resolveAmbiguousItem(o,oRecords[menuItem.get_reference()]);oItem.Execute()});item.set_actionCallback(sCallBack);_oAmbiguousPopup.addItem(item)}var anchorItem=Mscrm.MenuItem.createMenuItem(LOCID_LOOKMORERECORDS_AMBIGUOUS);anchorItem.set_stylePrefix(Mscrm.MenuStyles.lookupMruStylePrefix);var sCallBack=Function.createDelegate(this,function(menuItem){(new showLookupDialogForAmbiguous(oLookupCtrl,XUI.Html.GetText(o))).Execute()});anchorItem.set_actionCallback(sCallBack);anchorItem.get_itemContents().style.textAlign="center";if(!IsNull(XUI.DomUtilities.GetFirstChild(XUI.DomUtilities.GetChildElementAt(anchorItem.get_itemContents(),1)))){var rootSpan=XUI.DomUtilities.GetFirstChild(XUI.DomUtilities.GetChildElementAt(anchorItem.get_itemContents(),1));if(!IsNull(XUI.DomUtilities.GetFirstChild(rootSpan))){var leftSpan=XUI.DomUtilities.GetFirstChild(rootSpan);leftSpan.style.display="none"}}var className=anchorItem.get_itemClassName()+" popupMoreLinkItem";anchorItem.set_itemClassName(className);anchorItem.get_itemContents().className+=" popupMoreLinkItem";_oAmbiguousPopup.addItem(anchorItem);SetPopupDimension(_oAmbiguousPopup,oLookupCtrl);_oAmbiguousPopup.show()}else if(o.getAttribute("category")==LookupItemCategories.UNKNOWN){var oLookupCtrl=getLookupControlFromItemSpan(o);oLookupCtrl.Lookup(true,false,XUI.Html.GetText(o))}else o.getAttribute("category")!=LookupItemCategories.UNKNOWN_TYPE&&openObj(o.getAttribute("otype"),o.getAttribute("oid"))}function createMenu(){var menu=Mscrm.Menu.createMenu();menu.set_stylePrefix(Mscrm.MenuStyles.lookupMruStylePrefix);menu.set_propagateStyle(false);return menu}function SetPopupDimension(popupControl,oLookupCtrl){var lookupTextElement=XUI.Html.DomUtils.GetFirstChild(oLookupCtrl.get_rootControl()),xyPos=Mscrm.Utilities.getXYPos(lookupTextElement,!Mscrm.Utilities.get_isLeftToRight()),x=parseInt(xyPos["x"],10),y=parseInt(xyPos["y"],10),w=lookupTextElement.scrollWidth,h=lookupTextElement.scrollHeight;if(!Mscrm.Utilities.get_isLeftToRight()){x+=lookupTextElement.scrollWidth;if(Sys.Browser.agent===Sys.Browser.InternetExplorer)x+=8}if(w<190)w=190;if(w>400)w=400;if(Mscrm.Utilities.get_isLeftToRight())x=x+1;else x=x-1;y=y+h;popupControl.set_top(y);popupControl.set_left(x);popupControl.set_width(w)}function getLookupControlFromItemSpan(oItemSpan){for(var lookupTable=oItemSpan.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,tableCells=lookupTable.getElementsByTagName("td"),i=0;i<tableCells.length;i++)if(tableCells[i].className=="Lookup_RenderButton_td")return Mscrm.FormControlInputBehavior.GetElementBehavior(XUI.Html.DomUtils.GetFirstChild(tableCells[i]));return null}function resolveAmbiguousItem(oItem,oChangeToRecord){this.Execute=_execute;function _execute(){!IsNull(_oAmbiguousPopup)&&_oAmbiguousPopup.hide();for(var aoValues=[],aoKeyValues={},oLookupCtrl=getLookupControlFromItemSpan(oItem),oLookupItem=new LookupControlItem(oChangeToRecord.getAttribute("oid"),oChangeToRecord.getAttribute("otype"),oChangeToRecord.getAttribute("oname"),null,"ms-crm-Lookup-Item",null,null,false),i=0,len=oChangeToRecord.childNodes.length;i<len;i++){var oNode=oChangeToRecord.childNodes[i],sName=oNode.nodeName,sValue=XUI.Xml.GetText(oNode);aoValues.push(new LookupItemData(sName,sValue));aoKeyValues[sName]=new LookupItemData(sName,sValue)}oLookupItem.values=aoValues;oLookupItem.keyValues=aoKeyValues;oLookupCtrl.UpdateItem(oItem.getAttribute("oid"),oLookupItem,true)}}function showLookupDialogForAmbiguous(oLookupControl,sSearchString){this.Execute=_execute;function _execute(){oLookupControl.Lookup(true,false,sSearchString)}}var LookupItemCategories=null;populateLookupItemCategories();function populateLookupItemCategories(){if(IsNull(LookupItemCategories)){LookupItemCategories={};LookupItemCategories.NONE=0;LookupItemCategories.AMBIGUOUS=1;LookupItemCategories.UNKNOWN=2;LookupItemCategories.UNKNOWN_EMAIL=3;LookupItemCategories.NON_ENTITY=4;LookupItemCategories.UNKNOWN_TYPE=5;LookupItemCategories.MRU_ITEM=6}}function showSubjectTree(control_id,jsonTree_Data){var treeDialog=$("#"+control_id+"_treediv"),is_rtl=window.LOCID_UI_DIR.toUpperCase()=="RTL"?true:false,treeBehavior=Mscrm.FormControlInputBehavior.GetBehavior(control_id+"_i");if(treeBehavior.get_isTreeOpen()){closeTreeDialog();return}treeBehavior.set_isTreeOpen(true);!treeDialog.is(":data(dialog)")&&treeDialog.dialog({autoOpen:false,modal:false,closeText:"",open:function(){$("body").bind("click",function(e){if(treeDialog.dialog("isOpen")&&!($(e.target).parents().is("#"+control_id)||$(e.target).parents().is("#"+control_id+"_treediv"))){closeTreeDialog();$("body").unbind("click")}})},closeOnEscape:true,height:200,width:$("#"+control_id).width()});treeDialog.html("");treeDialog.append(LOCID_JSTREE_LOADING);treeDialog.css("border","1px solid #cccccc");treeDialog.css("background","#ffffff");treeDialog.dialog("open");if(compareGuids(jsonTree_Data.data[0].metadata.subjectid,EmptyGuid)){treeDialog.html("");treeDialog.append("<table><tr><td>&nbsp;</td></tr></table>");treeDialog.css("border","1px solid #cccccc");treeDialog.css("background","#ffffff")}else{var urltheme=null;if(Mscrm.InlineEditUtility.get_highContrastEnabled())urltheme="/_Static/_common/scripts/jstree_highcontrast.css";treeDialog.jstree({json_data:jsonTree_Data,themes:{dots:false,icons:false,url:urltheme},core:{animation:200,rtl:is_rtl},plugins:["themes","json_data","ui","wholerow","hotkeys"],hotkeys:{"return":function(){var hoveredObj=$(".jstree-hovered"),subjectItem=hoveredObj.first().text().trim();treeBehavior.selectInlineSubjectItem(subjectItem,this.data.ui.hovered.data().subjectid);closeTreeDialog()}}});treeDialog.bind("select_node.jstree",function(e,data){treeBehavior.selectInlineSubjectItem(data.inst.get_json()[0].data,data.inst.get_json()[0].metadata.subjectid);closeTreeDialog()});treeDialog.bind("loaded.jstree open_node.jstree close_node.jstree",function(){adjustForHighContrast()})}$(".ui-dialog-titlebar",treeDialog.parent()).hide();var positionOffset=$("#"+control_id+"_i").height()-$("#"+control_id+"_lookupTable").height()+2;setDimensions();function setDimensions(){var parentObj=$("#"+control_id+"_lookupTable"),cssParentObj={"min-width":"210px",position:"absolute",width:parentObj.width()-1},cssObj={height:"auto","max-height":"250px","min-height":"0%"};treeDialog.parent().css(cssParentObj);treeDialog.css(cssObj);control_id!="header_process_QuickCase_LinkControl_subjectid"&&treeDialog.parents(".ui-dialog").first().appendTo(parentObj.parent());treeDialog.parent().position({my:"left top",at:"left bottom",of:parentObj,offset:(is_rtl?"1":"0")+positionOffset,collision:"none"})}treeDialog.parents(".ui-dialog").first().bind("keydown",function(e){if(e.keyCode==Sys.UI.Key.esc){closeTreeDialog();e.preventDefault();e.stopPropagation();treeDialog.parents(".ui-dialog").first().unbind("keydown")}});treeDialog.parents(".ui-dialog").first().focus();function closeTreeDialog(){treeDialog.dialog("close");treeBehavior.set_isTreeOpen(false)}$(window).resize(function(){setDimensions()});function adjustForHighContrast(){if(Mscrm.InlineEditUtility.get_highContrastEnabled()){var circleUnicodeChar="\u25cb",rightArrowUnicodeChar="\u2192",leftArrowUnicodeChar="\u2190",southEastArrowUnicodeChar="\u2198",southWestArrowUnicodeChar="\u2199";$(".jstree-default .jstree-no-dots .jstree-leaf > ins").text(circleUnicodeChar);if(Mscrm.Utilities.get_isLeftToRight()){$(".jstree-default .jstree-no-dots .jstree-closed > ins").text(rightArrowUnicodeChar);$(".jstree-default .jstree-no-dots .jstree-open > ins").text(southEastArrowUnicodeChar)}else{$(".jstree-default .jstree-no-dots .jstree-closed > ins").text(leftArrowUnicodeChar);$(".jstree-default .jstree-no-dots .jstree-open > ins").text(southWestArrowUnicodeChar)}}}}